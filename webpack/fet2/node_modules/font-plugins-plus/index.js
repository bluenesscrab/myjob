'use strict';
var ai2font = require('fsk-font');
var path = require('path');
var fs = require('fs');

function FontPluginsPlus(options) {
  this.opt = Object.assign({}, options);
}

// 按照指定规则 递归扫描文件夹
// url {
//   fonts:{
//     url:''
//     runSelf:true,
//     reFolder:new RegExp('^fonts$','g')
//   },

// }

// function existFn(src, rule, callback){
//   fs.exists(dst, function( exists ){
//     if( exists ){ // 已存在
//       callback && callback( src, dst, rule );
//     }else{ // 不存在
//       fs.mkdir(dst, function(){
//         callback && callback( src, dst, rule );
//       });
//     }
//   });
// }

// //copy
// function copyFn( src, dst, rule ){
//   fs.readdir( src, function( err, paths ){
//     let fontsArr = paths.filter( item => {
//       return rule.test(item);
//     });
//     if( err ){
//       console.error(err);
//     }
//     fontsArr.forEach(function( path ){
//       var _src = src + '/' + path,
//           _dst = dst + '/' + path,
//           readable,writable;     
//       fs.stat( _src, function( err, st ){
//         if( st.isFile() ){ // 判断是否为文件
//           readable = fs.createReadStream( _src ); // 创建读取流
//           writable = fs.createWriteStream( _dst ); // 创建写入流 
//           readable.pipe( writable ); // 通过管道来传输流
//         }
//       });
//     });
//   });
// }


FontPluginsPlus.prototype.apply = function(compiler) {
  console.log('FontPluginsPlus apply')
  var contextPath = compiler.options.context; // 工作目录

  var copy = function( src, dst ){
    fs.readdir( src, function( err, paths ){
      let fontsArr = paths.filter( item => {
        return /\.svg$/.test(item);
      });
      if( err ){
        console.error(err);
      }
      fontsArr.forEach(function( path ){
        var _src = src + '/' + path,
            _dst = dst + '/' + path,
            readable,writable;     
        fs.stat( _src, function( err, st ){
          if( st.isFile() ){ // 判断是否为文件
            readable = fs.createReadStream( _src ); // 创建读取流
            writable = fs.createWriteStream( _dst ); // 创建写入流 
            readable.pipe( writable ); // 通过管道来传输流
          }
        });
      });
    });
  };

  var exists = function( src, dst, callback ){
    fs.exists( dst, function( exists ){
      if( exists ){ // 已存在
        callback( src, dst );
      }else{ // 不存在
        fs.mkdir( dst, function(){
          callback( src, dst );
        });
      }
    });
  };

  console.log( path.join(contextPath, '../fonts'), path.join(contextPath, '../asset/fonts'), copy );
  // exists( path.join(contextPath, '../fonts'), path.join(contextPath, '../asset/fonts'), copy );

};

module.exports = FontPluginsPlus;
